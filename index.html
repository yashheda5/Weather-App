<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather app</title>
    <link rel="stylesheet" href="./main.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="w-[100vw] h-[100vh] wrapper">
      <h1 class="text-center  uppercase pt-[40px] text-xl font-bold">Weather App</h1>
      <div class="flex justify-between w-[550px] my-[2rem] mx-auto">
        <p class=" cursor-grab " data-userWeather>Your  &nbsp;  Weather</p>
        <p class="cursor-grab" data-searchWeather>Search  &nbsp; Weather</p>
      </div>
      <div class="flex flex-col justify-center items-center my-[4rem]">
        <div data-grantloc class="grantLoc flex-col items-center gap-3 mt-[4rem] m-11 p-3">
          <img
            src="./assets/location.png"
            class="w-[90px] mb-[2rem]"
            loading="lazy"
            alt=""
          />
          <p class="text-[1.50rem] font-semibold">Grant Location Access</p>
          <p class="font-medium tracking-[0.75px]">Allow Access to Get Weather Information</p>
          <button class="text-[0.85rem] uppercase rounded-md cursor-grab py-[10px] px-[20px] btn m-2" data-grntAccess>Grant Access</button>
        </div>
        <form data-searchForm class="form flex  mx-w-[800px] justify-center items-center my-0 mx-auto w-[25rem] gap-[10px] mb-[3rem]">
          <input class="rounded-md  h-[40px] px-[25px] py-0 mx-2 ip"
            type="text"
            data-SearchInput
            placeholder="Search for city ..."
          />
          <button class="btn p-3 rounded-lg btnf">
            <img 
              src="./assets/search.png"
              loading="lazy"
              width="20"
              height="20"
              alt=""
            />
          </button>
        </form>
        <div class="load flex flex-col items-center" data-loadingScreen>
          <img src="./assets/loading.gif" width="150" height="150" alt="" />
          <p class="uppercase">Loading...</p>
        </div>
        <div data-userInfo class="ui flex flex-col items-center">
          <div class="flex items-center gap-y-0 gap-x-[0.5rem] mb-[0.5rem]">
            <p data-cityName class="text-3xl"></p>
            <img data-countryIcon width="35px" height="35px" src="" alt="" />
          </div>
          <p data-weatherDesc class="text-[1.25rem] font-extralight "></p>
          <img src="" width="80px" height="80px" data-weatherIcon alt="" />
          <p data-temp class="text-[1.75rem] font-bold"></p>
          <div class="flex gap-y-[5px] gap-x-[20px] justify-center items-center mt-[1rem] w-[65rem]">
            <div class="parameter">
              <img src="./assets/wind.png" alt="" />
              <p>Wind Speed</p>
              <p data-windSpeed></p>
            </div>
            <div class="parameter">
              <img src="./assets/humidity.png" alt="" />
              <p>Humidity</p>
              <p data-humidity></p>
            </div>
            <div class="parameter">
              <img src="./assets/cloud.png" alt="" />
              <p>Clouds</p>
              <p data-clouds></p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      let userTab = document.querySelector("[data-userWeather]");
      let searchTab = document.querySelector("[data-searchWeather]");
      let userInfo = document.querySelector("[data-userInfo]");
      let loadingScreen = document.querySelector("[data-loadingScreen]");
      let grantLoc = document.querySelector("[data-grantloc]");
      let currentTab = userTab;
      let API_key = "9330b83d17af516af673f0aae5a42077";
      let searchForm = document.querySelector("[data-searchForm]");
      
      getFromSessionStorage();
      currentTab.classList.add("current-tab");

      function switchTab(clickedTab) {
        if (clickedTab !== currentTab) {
          currentTab.classList.remove("current-tab");
          currentTab = clickedTab;
          currentTab.classList.add("current-tab");
          
          if (!searchForm.classList.contains("active")) {
            userInfo.classList.remove("active");
            grantLoc.classList.remove("active");
            searchForm.classList.add("active");
          } else {
            searchForm.classList.remove("active");
            userInfo.classList.remove("active");
            getFromSessionStorage();
          }
        }
      }

      userTab.addEventListener("click", () => {
        switchTab(userTab);
      });

      searchTab.addEventListener("click", () => {
        switchTab(searchTab);
      });

      function getFromSessionStorage() {
        const localCoordinates = sessionStorage.getItem("user-coordinates");
        if (!localCoordinates) {
          grantLoc.classList.add("active");
        } else {
          const coordinates = JSON.parse(localCoordinates);
          fetchWeatherInfo(coordinates);
        }
      }

      async function fetchWeatherInfo(coordinates) {
        const { lat, lon } = coordinates;
        grantLoc.classList.remove("active");
        loadingScreen.classList.add("active");

        try {
          let result = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_key}&units=metric`
          );
        
            let data = await result.json();
          loadingScreen.classList.remove("active");
          userInfo.classList.add("active");
          renderWeatherInfo(data);
         
        } catch (e) {
          loadingScreen.classList.remove("active");
          alert("Failed to fetch weather information.");
          
        }
      }

      function renderWeatherInfo(weatherInfo) {
        let cityName = document.querySelector("[data-cityName]");
        let countryIcon = document.querySelector("[data-countryIcon]");
        let desc = document.querySelector("[data-weatherDesc]");
        let weatherIcon = document.querySelector("[data-weatherIcon]");
        let temp = document.querySelector("[data-temp]");
        let windSpeed = document.querySelector("[data-windSpeed]");
        let humidity = document.querySelector("[data-humidity]");
        let clouds = document.querySelector("[data-clouds]");

        cityName.innerText = weatherInfo?.name || "N/A";
        countryIcon.src = `https://flagcdn.com/144x108/${weatherInfo?.sys?.country.toLowerCase()}.png`;
        desc.innerText = weatherInfo?.weather?.[0]?.description || "N/A";
        weatherIcon.src = `http://openweathermap.org/img/w/${weatherInfo?.weather?.[0]?.icon}.png`;
        temp.innerText = `${weatherInfo?.main?.temp || "N/A"} Â°C`;
        windSpeed.innerText = `${weatherInfo?.wind?.speed || "N/A"} m/s`;
        humidity.innerText = `${weatherInfo?.main?.humidity || "N/A"} %`;
        clouds.innerText = `${weatherInfo?.clouds?.all || "N/A"} %`;
      }

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }

      function showPosition(position) {
        const userCoordinates = {
          lat: position.coords.latitude,
          lon: position.coords.longitude,
        };
        sessionStorage.setItem("user-coordinates", JSON.stringify(userCoordinates));
        fetchWeatherInfo(userCoordinates);
      }

      const grantAccessButton = document.querySelector("[data-grntAccess]");
      grantAccessButton.addEventListener("click", getLocation);

      let searchInput = document.querySelector("[data-SearchInput]");
      searchForm.addEventListener("submit", (e) => {
        e.preventDefault();
        let cityName = searchInput.value;

        if (cityName === "") return;
        fetchSearchWeatherInfo(cityName);
      });

      async function fetchSearchWeatherInfo(city) {
        loadingScreen.classList.add("active");
        userInfo.classList.remove("active");
        grantLoc.classList.remove("active");

        try {
          const response = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${API_key}&units=metric`
          );
          const data = await response.json();
          loadingScreen.classList.remove("active");
          userInfo.classList.add("active");
          renderWeatherInfo(data);
        } catch (err) {
          loadingScreen.classList.remove("active");
          userInfo.classList.remove("active");
          grantLoc.classList.remove("active");
          alert("Failed to fetch weather information for the searched city.");
        }
      }
    </script>
  </body>
</html>
